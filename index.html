<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Wrap image in 3D cylinder - 2 | CSSDeck</title>
  <link rel="stylesheet" type="text/css" href="./index.css">
</head>

<body>
  <div id="container">
    <h1>image wrapped around a cylindrical shape</h1>
    <div class="settings-pagel">
      <div class="input-container">
        <label>Radius</label>
        <input id="cylinder-radius" type="range" name="volume" min="0" max="2000" change="updateSettings()">
      </div>
      <div class="input-container">
        <label>Height</label>
        <input id="cylinder-warped-rectangle-height" type="range" name="volume" min="0" max="500"
          change="updateSettings()">
      </div>
      <div class="input-container">
        <label>Position y axis</label>
        <input id="cylinder-warped-rectangle-y" type="range" name="volume" min="0" max="300" change="updateSettings()">
      </div>
      <div class="input-container">
        <label>Position x axis</label>
        <input id="cylinder-warped-rectangle-x" type="range" name="volume" min="-100" max="100"
          change="updateSettings()">
      </div>
      <div class="input-container">
        <label>Rotation y axis</label>
        <input id="cylinder-warped-rectangle-rotate-y" type="range" name="volume" min="0" max="360"
          change="updateSettings()">
      </div>
      <div class="input-container">
        <label>Rotation x axis</label>
        <input id="cylindrical-container-rotate-x" type="range" name="volume" min="0" max="360"
          change="updateSettings()">
      </div>
      <div class="input-container">
        <label>White label presentation mode?</label>
        <input id="presentation-mode" type="checkbox" name="volume" change="updateSettings()">
      </div>
    </div>
    <div class="cylindrical-product-display-container cpdc">
      <div class="product">
        <img
          src="https://mms-images.staging.customink.com/mms/images/catalog/colors/364000/views/back.jpg?digest=6cf15c94c3292e10bac13082301b4f12"
          class="product-imagery">
      </div>
      <div class="cylindrical-container">
        <img
          src="https://mms-images.staging.customink.com/mms/images/catalog/colors/364000/views/back.jpg?digest=6cf15c94c3292e10bac13082301b4f12"
          class="product-imagery">
        <div class="warped-rectangle">
          <div class="section s1"></div>
          <div class="section s2"></div>
          <div class="section s3"></div>
          <div class="section s4"></div>
          <div class="section s5"></div>
          <div class="section s6"></div>
          <div class="section s7"></div>
          <div class="section s8"></div>
          <div class="section s9"></div>
          <div class="section s10"></div>
          <div class="section s11"></div>
          <div class="section s12"></div>
          <div class="section s13"></div>
          <div class="section s14"></div>
          <div class="section s15"></div>
          <div class="section s16"></div>
          <div class="section s17"></div>
          <div class="section s18"></div>
          <div class="section s19"></div>
          <div class="section s20"></div>
          <div class="section s21"></div>
          <div class="section s22"></div>
          <div class="section s23"></div>
          <div class="section s24"></div>
          <div class="section s25"></div>
          <div class="section s26"></div>
          <div class="section s27"></div>
          <div class="section s28"></div>
          <div class="section s29"></div>
          <div class="section s30"></div>
          <div class="section s31"></div>
          <div class="section s32"></div>
          <div class="section s33"></div>
          <div class="section s34"></div>
          <div class="section s35"></div>
          <div class="section s36"></div>
          <div class="section s37"></div>
          <div class="section s38"></div>
          <div class="section s39"></div>
          <div class="section s40"></div>
          <div class="section s41"></div>
          <div class="section s42"></div>
          <div class="section s43"></div>
          <div class="section s44"></div>
          <div class="section s45"></div>
          <div class="section s46"></div>
          <div class="section s47"></div>
          <div class="section s48"></div>
          <div class="section s49"></div>
          <div class="section s50"></div>
          <div class="section s51"></div>
          <div class="section s52"></div>
          <div class="section s53"></div>
          <div class="section s54"></div>
          <div class="section s55"></div>
          <div class="section s56"></div>
          <div class="section s57"></div>
          <div class="section s58"></div>
          <div class="section s59"></div>
          <div class="section s60"></div>
          <div class="section s61"></div>
          <div class="section s62"></div>
          <div class="section s63"></div>
          <div class="section s64"></div>
          <div class="section s65"></div>
          <div class="section s66"></div>
          <div class="section s67"></div>
          <div class="section s68"></div>
          <div class="section s69"></div>
          <div class="section s70"></div>
          <div class="section s71"></div>
          <div class="section s72"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function createCanvasAlternative() {
      var createImage = function (w, h) { 
        var i = document.createElement("canvas"); i.width = w; i.height = h; i.ctx = i.getContext("2d"); return i; 
      }

      var canvas = createImage(400, 400);
      var ctx = canvas.ctx;
      document.body.appendChild(canvas)
      ctx.clearRect(0, 0, 500, 500)
      var image = createImage(400, 200);
      image.ctx.font = "60px arial";
      image.ctx.textAlign = "center";
      image.ctx.fillStyle = "#7F5";
      image.ctx.fillRect(0, 0, image.width, image.height)
      image.ctx.fillStyle = "white";
      image.ctx.fillText("Wrap around", 200, 60)
      image.ctx.fillText("Some images", 200, 140)

      function draw(ang, tilt, perspective) {
        var step = 1 / (Math.max(image.width, 400));
        for (var i = 0; i < 1; i += step) {
          var a = i * Math.PI;
          var a1 = (i + step * 2) * Math.PI;
          var ix = i * image.width * 1.2;
          var iw = step * image.width * 1.2;
          a += ang * Math.PI * 2;
          a1 += ang * Math.PI * 2;
          a = Math.PI - a;
          a1 = Math.PI - a1;
          var x = canvas.width * 0.5;
          var y = canvas.height * 0.1;

          var x1 = x + Math.cos(a1) * 110;
          var y1 = y + Math.sin(a) * tilt;
          x += Math.cos(a) * 110;
          y += Math.sin(a) * tilt;
          var s = Math.sin(a);
          var s1 = Math.sin(a1);
          if (s > 0 || s1 > 0) {
            ctx.drawImage(image, ix, 0, iw, image.height, x1, y - s * perspective * 0.5, x - x1, 200 + s * perspective)
          }
        }
      }
      var w = canvas.width;
      var h = canvas.height;

      // main update function
      function update(timer) {
        ctx.setTransform(1, 0, 0, 1, 0, 0); // reset transform
        ctx.globalAlpha = 1;                // reset alpha
        ctx.fillStyle = "black"
        ctx.fillRect(0, 0, w, h);
        draw(timer / 2000, 40, 30)
        requestAnimationFrame(update);
      }
      requestAnimationFrame(update);
    }

    // References: 
    // https://github.com/lovell/sharp/issues/1737

    // https://24ways.org/2010/intro-to-css-3d-transforms/
    // https://css-tricks.com/almanac/properties/t/transform/
    // Canvas alternative: https://stackoverflow.com/questions/40997344/wrap-an-image-around-a-cylindrical-object-in-html5-javascript

    //anim-infinite-rotation -> start anim

    //.warped-rectangle -> item selector
    //document.querySelectorAll(".warped-rectangle .section");
    //.warped-rectangle .section {
    //   position: absolute;
    //   /* background: url("https://design-raster.out.customink.com/designs/svv0-00ck-6rxn/front.png"); */
    //   background: url("https://mms-images.staging.customink.com/mms/images/catalog/colors/364000/views/back.jpg?digest=6cf15c94c3292e10bac13082301b4f12");
    //   border-width: thin 0;
    //   height: 500px;
    //   width: 34px;
    //   opacity: 1;
    //   border: 1px solid transparent;
    // }

    let settings = {
      radius: 900,
      warpedRectangleHeight: 200,
      warpedRectangleY: 150,
      warpedRectangleX: 0,
      warpedRectangleRotateY: 0,
      cylindricalContainerRotateX: 0,
      presentationMode: false
    };

    initEvents();
    createCylinder(settings);
    // createCanvasAlternative();

    function initEvents() {
      const radiusInput = document.querySelector('#cylinder-radius');
      const warpedRectangleHeightInput = document.querySelector('#cylinder-warped-rectangle-height');
      const warpedRectangleYInput = document.querySelector('#cylinder-warped-rectangle-y');
      const warpedRectangleXInput = document.querySelector('#cylinder-warped-rectangle-x');
      const warpedRectangleRotateYInput = document.querySelector('#cylinder-warped-rectangle-rotate-y');
      const cylindricalContainerRotateXInput = document.querySelector('#cylindrical-container-rotate-x');
      const presentationModeInput = document.querySelector('#presentation-mode');

      radiusInput.addEventListener('change', (event) => {
        updateSettings({
          radius: event.target.value
        });
      });
      warpedRectangleHeightInput.addEventListener('change', (event) => {
        updateSettings({
          warpedRectangleHeight: event.target.value
        });
      });
      warpedRectangleYInput.addEventListener('change', (event) => {
        updateSettings({
          warpedRectangleY: event.target.value
        });
      });
      warpedRectangleXInput.addEventListener('change', (event) => {
        updateSettings({
          warpedRectangleX: event.target.value
        });
      });
      warpedRectangleRotateYInput.addEventListener('change', (event) => {
        updateSettings({
          warpedRectangleRotateY: event.target.value
        });
      });
      cylindricalContainerRotateXInput.addEventListener('change', (event) => {
        updateSettings({
          cylindricalContainerRotateX: event.target.value
        });
      });
      presentationModeInput.addEventListener('change', (event) => {
        updateSettings({
          presentationMode: event.target.checked
        });
      });
    }

    function updateSettings({ radius, warpedRectangleHeight, warpedRectangleY, warpedRectangleX,
      warpedRectangleRotateY, cylindricalContainerRotateX, presentationMode }) {
      createCylinder({
        radius: radius ? radius : settings.radius,
        warpedRectangleHeight: warpedRectangleHeight ? warpedRectangleHeight : settings.warpedRectangleHeight,
        warpedRectangleY: warpedRectangleY ? warpedRectangleY : settings.warpedRectangleY,
        warpedRectangleX: warpedRectangleX ? warpedRectangleX : settings.warpedRectangleX,
        warpedRectangleRotateY: warpedRectangleRotateY ? warpedRectangleRotateY : settings.warpedRectangleRotateY,
        cylindricalContainerRotateX: cylindricalContainerRotateX ? cylindricalContainerRotateX : settings.cylindricalContainerRotateX,
        presentationMode: typeof presentationMode != 'undefined' ? presentationMode : settings.presentationMode
      });
    }

    function createCylinder({ radius, warpedRectangleHeight, warpedRectangleY, warpedRectangleX,
      warpedRectangleRotateY, cylindricalContainerRotateX, presentationMode }) {
      settings = { radius, warpedRectangleHeight, warpedRectangleY, warpedRectangleX, warpedRectangleRotateY, cylindricalContainerRotateX, presentationMode };

      const imgWidth = radius ? radius : 900;

      const cylindricalContainer = document.querySelector(".cylindrical-container");
      const cylinder = document.querySelector(".warped-rectangle");
      const cylinderSides = document.querySelectorAll(".warped-rectangle .section");

      const numSections = cylinderSides.length;
      const yRectSectionRotationIncrement = 360 / numSections;

      const imgWidthIncrement = (imgWidth / numSections);
      const translateZ = (imgWidth / (2 * Math.PI));

      let rectSectionXRotation = 0;
      let rectSectionYRotation = 0;
      let rectSectionZRotation = 0;
      let sectionImgWidth = imgWidth;

      const productImagery = document.querySelector('.cpdc .cylindrical-container .product-imagery');
      const wrapedRectangle = document.querySelector('.cpdc .cylindrical-container .warped-rectangle');
      const wrapedRectangleSection = document.querySelector('.cpdc .cylindrical-container .warped-rectangle .section');

      if (presentationMode) {
        productImagery.classList.add("white-label-mode");
        wrapedRectangle.classList.add("white-label-mode");
        //wrapedRectangleSection.forEach(item => item.classList.add("white-label-mode"));
        //wrapedRectangleSection.classList.add("white-label-mode");
      } else {
        productImagery.classList.remove("white-label-mode");
        wrapedRectangle.classList.remove("white-label-mode");
        //wrapedRectangleSection.classList.remove("white-label-mode");
        //wrapedRectangleSection.forEach(item => item.classList.remove("white-label-mode"));
      }

      cylindricalContainer.style['-moz-transform'] = `rotateX(${cylindricalContainerRotateX}deg)`;
      cylindricalContainer.style['-webkit-transform'] = `rotateX(${cylindricalContainerRotateX}deg)`;

      cylinder.style['height'] = `${warpedRectangleHeight}px`;
      cylinder.style['top'] = `${warpedRectangleY}px`;
      cylinder.style['left'] = `${warpedRectangleX}px`;
      cylinder.style['left'] = `${warpedRectangleX}px`;
      cylinder.style['-moz-transform'] = `rotateY(${warpedRectangleRotateY}deg)`;
      cylinder.style['-webkit-transform'] = `rotateY(${warpedRectangleRotateY}deg)`;

      cylinderSides.forEach((cylinderPart, idx) => {
        cylinderPart.style['width'] = `${imgWidthIncrement}px`;

        if (idx === 0) {
          cylinderPart.style['background-position'] = `0 -1`;
        } else {
          sectionImgWidth -= imgWidthIncrement;
          cylinderPart.style['background-position'] = `${sectionImgWidth}px -1`;
        }

        cylinderPart.style['-moz-transform'] = `rotateX(${rectSectionXRotation}deg) rotateY(${rectSectionYRotation}deg) rotateZ(${rectSectionZRotation}) translateZ(${translateZ}px)`;
        cylinderPart.style['-webkit-transform'] = `rotateX(${rectSectionXRotation}deg) rotateY(${rectSectionYRotation}deg) rotateZ(${rectSectionZRotation}) translateZ(${translateZ}px)`;

        rectSectionYRotation += yRectSectionRotationIncrement;
      });
    }
  </script>

</html>